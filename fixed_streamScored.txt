// Fixed streamScored method
def streamScored(implicit transaction: Transaction[Doc]): rapid.Stream[(V, Double)] = {
  def fetchPage(offset: Int): Task[SearchResults[Doc, Model, V]] = {
    val pagedQuery = copy(offset = offset, countTotal = offset == this.offset)
    pagedQuery.search
  }

  def fetchAllPages(endOffset: Int, offset: Int): rapid.Stream[(V, Double)] = {
    if (offset >= endOffset) {
      rapid.Stream.empty
    } else {
      rapid.Stream.force(fetchPage(offset).flatMap { searchResults =>
        val nextPageStream = fetchAllPages(endOffset, offset + pageSize)
        Task.pure(searchResults.streamWithScore ++ nextPageStream)
      })
    }
  }

  rapid.Stream.force(fetchPage(offset).flatMap { firstPageResults =>
    val total = firstPageResults.total.get
    scribe.info(s"TOTAL: $total")
    val endOffset = this.limit match {
      case Some(l) => offset + math.min(l, total - offset)
      case None => total
    }
    Task.pure(fetchAllPages(endOffset, offset))
  })
}